# Configuración de Permisos de Bedrock para Conversaciones AI

## Resumen

Esta documentación explica cómo configurar correctamente los permisos de AWS Bedrock para que las conversaciones AI funcionen en Amplify Gen 2. Este proceso es necesario cuando se implementa la funcionalidad de conversaciones AI con modelos de Bedrock.

## Problema Común

### Error Típico

```
AccessDeniedException: User: arn:aws:sts::ACCOUNT_ID:assumed-role/amplify-awsamplifygen2-xo-ChatDefaultConversationHa-XXXXX/amplify-awsamplifygen2-xo-ChatDefaultConversationH-XXXXX is not authorized to perform: bedrock:InvokeModelWithResponseStream on resource: arn:aws:bedrock:us-east-2:ACCOUNT_ID:inference-profile/us.anthropic.claude-3-haiku-20240307-v1:0 because no identity-based policy allows the bedrock:InvokeModelWithResponseStream action
```

### Causa Raíz

El rol de Lambda `ChatDefaultConversationHandler` creado automáticamente por Amplify Gen 2 no tiene los permisos necesarios para invocar modelos de Bedrock con streaming.

## Solución Paso a Paso

### 1. Identificar el Rol Correcto

Primero, necesitas encontrar el nombre exacto del rol de Lambda:

```bash
# Listar todos los roles de IAM
aws iam list-roles --query 'Roles[?contains(RoleName, `ChatDefaultConversationHandler`)].RoleName' --output text
```

El resultado será algo como:

```
amplify-awsamplifygen2-xo-ChatDefaultConversationHa-pbakNn0wApO1
```

### 2. Crear la Política de Permisos

Crear una política IAM con los permisos necesarios:

```bash
# Crear la política
aws iam create-policy \
  --policy-name BedrockConversationPermissions \
  --policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": [
          "bedrock:InvokeModel",
          "bedrock:InvokeModelWithResponseStream",
          "bedrock:CreateInferenceProfile",
          "bedrock:GetInferenceProfile",
          "bedrock:ListInferenceProfiles"
        ],
        "Resource": [
          "arn:aws:bedrock:*::foundation-model/*",
          "arn:aws:bedrock:*:*:inference-profile/*",
          "arn:aws:bedrock:*:*:application-inference-profile/*"
        ]
      }
    ]
  }'
```

### 3. Adjuntar la Política al Rol

```bash
# Reemplazar ROLE_NAME con el nombre real del rol encontrado en el paso 1
aws iam attach-role-policy \
  --role-name amplify-awsamplifygen2-xo-ChatDefaultConversationHa-pbakNn0wApO1 \
  --policy-arn arn:aws:iam::ACCOUNT_ID:policy/BedrockConversationPermissions
```

### 4. Verificar la Configuración

```bash
# Verificar que la política esté adjunta
aws iam list-attached-role-policies --role-name amplify-awsamplifygen2-xo-ChatDefaultConversationHa-pbakNn0wApO1

# Verificar el contenido de la política
aws iam get-policy-version \
  --policy-arn arn:aws:iam::ACCOUNT_ID:policy/BedrockConversationPermissions \
  --version-id v1
```

## Configuración en el Código

### Esquema de Conversación AI

En `amplify/data/resource.ts`, asegúrate de que la conversación esté configurada correctamente:

```typescript
chat: a
  .conversation({
    aiModel: {
      resourcePath: 'us.anthropic.claude-3-haiku-20240307-v1:0',
    },
    systemPrompt: 'You are a helpful assistant',
  })
  .authorization((allow) => allow.owner()),
```

### Aplicación de Permisos en Backend

En `amplify/backend.ts`, puedes agregar lógica para aplicar permisos automáticamente:

```typescript
import { PolicyStatement, Effect } from 'aws-cdk-lib/aws-iam';

// Aplicar permisos de Bedrock para la conversación AI
const bedrockPolicyStatement = new PolicyStatement({
  effect: Effect.ALLOW,
  actions: [
    'bedrock:InvokeModel',
    'bedrock:InvokeModelWithResponseStream',
    'bedrock:CreateInferenceProfile',
    'bedrock:GetInferenceProfile',
    'bedrock:ListInferenceProfiles',
  ],
  resources: [
    'arn:aws:bedrock:*::foundation-model/*',
    'arn:aws:bedrock:*:*:inference-profile/*',
    'arn:aws:bedrock:*:*:application-inference-profile/*',
  ],
});

// Aplicar permisos al rol de la conversación AI
try {
  console.log('Aplicando permisos de Bedrock a la conversación AI...');

  // Buscar todos los roles disponibles en los recursos CFN
  const cfnResources = backend.data.resources.cfnResources;
  if (cfnResources) {
    Object.keys(cfnResources).forEach((key) => {
      const resource = cfnResources[key as keyof typeof cfnResources];
      if (resource && typeof resource === 'object' && 'addToPolicy' in resource) {
        try {
          (resource as any).addToPolicy(bedrockPolicyStatement);
          console.log(`Permisos de Bedrock aplicados a: ${key}`);
        } catch (error) {
          console.log(`Error aplicando permisos a ${key}:`, error);
        }
      }
    });
  }
} catch (error) {
  console.error('Error aplicando permisos de Bedrock a la conversación AI:', error);
}
```

## Verificación de la Solución

### 1. Probar la Conversación AI

Una vez aplicados los permisos, prueba la funcionalidad:

```typescript
// En tu componente de prueba
const { data: conversation } = await client.conversations.chat.create();
const { data: message } = await conversation.sendMessage({
  content: [{ text: 'Hola, ¿cómo estás?' }],
  aiContext: {
    user: {
      name: 'Usuario de Prueba',
    },
  },
});
```

### 2. Verificar Logs

Revisa los logs de CloudWatch para confirmar que no hay errores de permisos:

```bash
# Ver logs de la función Lambda
aws logs tail /aws/lambda/[FUNCTION_NAME] --follow
```

## Troubleshooting

### Error Persiste Después de Aplicar Permisos

1. **Verificar propagación**: Los permisos pueden tardar hasta 5 minutos en propagarse
2. **Verificar rol correcto**: Asegúrate de usar el rol exacto encontrado en el paso 1
3. **Verificar política**: Confirma que la política incluye `bedrock:InvokeModelWithResponseStream`

### Error de Modelo No Soportado

Si recibes un error sobre el modelo no soportado:

```
ValidationException: Invocation of model ID anthropic.claude-3-haiku-20240307-v1:0 with on-demand throughput isn't supported
```

Cambia a un modelo compatible:

```typescript
chat: a
  .conversation({
    aiModel: a.ai.model('Claude 3.5 Haiku'), // Usar modelo compatible
    systemPrompt: 'You are a helpful assistant',
  })
  .authorization((allow) => allow.owner()),
```

## Script de Automatización

Para automatizar este proceso en futuros despliegues, puedes crear un script:

```bash
#!/bin/bash
# scripts/setup-bedrock-permissions.sh

ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
ROLE_NAME=$(aws iam list-roles --query 'Roles[?contains(RoleName, `ChatDefaultConversationHandler`)].RoleName' --output text)

if [ -z "$ROLE_NAME" ]; then
  echo "Error: No se encontró el rol ChatDefaultConversationHandler"
  exit 1
fi

echo "Configurando permisos de Bedrock para rol: $ROLE_NAME"

# Crear política si no existe
aws iam create-policy \
  --policy-name BedrockConversationPermissions \
  --policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": [
          "bedrock:InvokeModel",
          "bedrock:InvokeModelWithResponseStream",
          "bedrock:CreateInferenceProfile",
          "bedrock:GetInferenceProfile",
          "bedrock:ListInferenceProfiles"
        ],
        "Resource": [
          "arn:aws:bedrock:*::foundation-model/*",
          "arn:aws:bedrock:*:*:inference-profile/*",
          "arn:aws:bedrock:*:*:application-inference-profile/*"
        ]
      }
    ]
  }' 2>/dev/null || echo "Política ya existe"

# Adjuntar política al rol
aws iam attach-role-policy \
  --role-name "$ROLE_NAME" \
  --policy-arn "arn:aws:iam::$ACCOUNT_ID:policy/BedrockConversationPermissions"

echo "Permisos configurados exitosamente"
```

## Consideraciones Importantes

### Seguridad

- Los permisos son específicos para Bedrock y no incluyen otros servicios
- Se usan wildcards (`*`) para permitir acceso a todos los modelos de Bedrock
- Los permisos se aplican solo al rol específico de la conversación AI

### Costos

- Bedrock cobra por tokens procesados
- El streaming puede generar costos adicionales
- Monitorea el uso en la consola de AWS

### Limitaciones

- Algunos modelos requieren inference profiles
- El modelo `claude-3-haiku-20240307-v1:0` requiere configuración específica
- Los permisos pueden tardar en propagarse

## Referencias

- [AWS Bedrock Documentation](https://docs.aws.amazon.com/bedrock/)
- [Amplify Gen 2 AI Conversations](https://docs.amplify.aws/nextjs/ai/conversation/)
- [IAM Policy Reference](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies.html)

---

**Última actualización**: Enero 2025 - Solución verificada y documentada
