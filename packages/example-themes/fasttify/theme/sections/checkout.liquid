{% comment %}
  Sección principal del checkout
  Muestra el formulario de información del cliente y resumen del pedido
{% endcomment %}
{{ 'checkout.css' | asset_url | stylesheet_tag }}

<section class="checkout-section" data-section-id="{{ section.id }}">
  <div class="checkout-container">
    {% if checkout %}
      <div class="checkout-header">
        <h1 class="checkout-title">Finalizar Compra</h1>
        <p class="checkout-subtitle">Completa tu información para procesar tu pedido</p>
      </div>

        <div class="checkout-layout">
          <!-- Formulario de información del cliente -->
          <div class="checkout-form-section">
            <form action="/api/stores/{{ checkout.storeId }}/checkout/complete?token={{ checkout.token }}" method="post" class="checkout-form" id="checkout-form">
              <input type="hidden" name="checkout_token" value="{{ checkout.token }}">

              <!-- Información de contacto -->
              <div class="form-section">
                <h2 class="form-section-title">Información de Contacto</h2>

                <div class="form-row">
                  <div class="form-group">
                    <label for="customer_email" class="form-label required">Email</label>
                    <input
                      type="email"
                      id="customer_email"
                      name="customer[email]"
                      class="form-input"
                      value="{{ checkout.customer.email | default: '' }}"
                      required
                      placeholder="tu@email.com"
                    >
                  </div>
                </div>

                <div class="form-row two-columns">
                  <div class="form-group">
                    <label for="customer_first_name" class="form-label required">Nombre</label>
                    <input
                      type="text"
                      id="customer_first_name"
                      name="customer[firstName]"
                      class="form-input"
                      value="{{ checkout.customer.firstName | default: '' }}"
                      required
                      placeholder="Tu nombre"
                    >
                  </div>
                  <div class="form-group">
                    <label for="customer_last_name" class="form-label required">Apellido</label>
                    <input
                      type="text"
                      id="customer_last_name"
                      name="customer[lastName]"
                      class="form-input"
                      value="{{ checkout.customer.lastName | default: '' }}"
                      required
                      placeholder="Tu apellido"
                    >
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="customer_phone" class="form-label">Teléfono</label>
                    <input
                      type="tel"
                      id="customer_phone"
                      name="customer[phone]"
                      class="form-input"
                      value="{{ checkout.customer.phone | default: '' }}"
                      placeholder="+57 300 123 4567"
                    >
                  </div>
                </div>
              </div>

              <!-- Dirección de envío -->
              <div class="form-section">
                <h2 class="form-section-title">Dirección de Envío</h2>

                <div class="form-row">
                  <div class="form-group">
                    <label for="shipping_address1" class="form-label required">Dirección</label>
                    <input
                      type="text"
                      id="shipping_address1"
                      name="shipping_address[address1]"
                      class="form-input"
                      value="{{ checkout.shipping_address.address1 | default: '' }}"
                      required
                      placeholder="Calle 123 #45-67"
                    >
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="shipping_address2" class="form-label">Apartamento, suite, etc.</label>
                    <input
                      type="text"
                      id="shipping_address2"
                      name="shipping_address[address2]"
                      class="form-input"
                      value="{{ checkout.shipping_address.address2 | default: '' }}"
                      placeholder="Apt 101, Torre A"
                    >
                  </div>
                </div>

                <div class="form-row two-columns">
                  <div class="form-group">
                    <label for="shipping_city" class="form-label required">Ciudad</label>
                    <input
                      type="text"
                      id="shipping_city"
                      name="shipping_address[city]"
                      class="form-input"
                      value="{{ checkout.shipping_address.city | default: '' }}"
                      required
                      placeholder="Bogotá"
                    >
                  </div>
                  <div class="form-group">
                    <label for="shipping_state" class="form-label required">Departamento</label>
                    <input
                      type="text"
                      id="shipping_state"
                      name="shipping_address[state]"
                      class="form-input"
                      value="{{ checkout.shipping_address.state | default: '' }}"
                      required
                      placeholder="Cundinamarca"
                    >
                  </div>
                </div>

                <div class="form-row two-columns">
                  <div class="form-group">
                    <label for="shipping_zip" class="form-label">Código Postal</label>
                    <input
                      type="text"
                      id="shipping_zip"
                      name="shipping_address[zip]"
                      class="form-input"
                      value="{{ checkout.shipping_address.zip | default: '' }}"
                      placeholder="110111"
                    >
                  </div>
                  <div class="form-group">
                    <label for="shipping_country" class="form-label">País</label>
                    <select id="shipping_country" name="shipping_address[country]" class="form-select">
                      <option value="CO" {% if checkout.shipping_address.country == 'CO' %}selected{% endif %}>Colombia</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Notas adicionales -->
              <div class="form-section">
                <h2 class="form-section-title">Notas del Pedido</h2>
                <div class="form-row">
                  <div class="form-group">
                    <label for="order_notes" class="form-label">Instrucciones especiales (opcional)</label>
                    <textarea
                      id="order_notes"
                      name="notes"
                      class="form-textarea"
                      rows="3"
                      placeholder="Instrucciones de entrega, comentarios especiales, etc."
                    >{{ checkout.note | default: '' }}</textarea>
                  </div>
                </div>
              </div>

              <!-- Botón de envío -->
              <div class="form-section">
                <button type="submit" class="checkout-button primary" id="submit-checkout">
                  <span class="btn-text"><span>Completar Pedido</span></span>
                  <span class="btn-loading" style="display: none;">
                    <span class="loading-spinner"></span><span>Procesando...</span>
                  </span>
                </button>

                <p class="form-success">
                  Al completar el pedido, el dueño de la tienda recibirá los detalles y se pondrá en contacto contigo para coordinar el pago y la entrega.
                </p>
              </div>
            </form>
          </div>

          <!-- Resumen del pedido -->
          <div class="order-summary">
            <h2 class="summary-title">Resumen del Pedido</h2>

            <div class="summary-products">
              {% for item in checkout.line_items %}
                <div class="summary-product">
                  {% if item.image %}
                    <img src="{{ item.image }}" alt="{{ item.title }}" loading="lazy" class="product-image">
                  {% else %}
                    <div class="product-image-placeholder">
                      Sin imagen
                    </div>
                  {% endif %}

                  <div class="product-details">
                    <h3 class="product-name">{{ item.title }}</h3>
                    {% if item.variant_title and item.variant_title != 'Default Title' %}
                      <p class="product-variant">{{ item.variant_title }}</p>
                    {% endif %}
                    {% if item.selectedAttributes %}
                      {% for attribute in item.selectedAttributes %}
                        <p class="product-attribute">{{ attribute[0] }}: {{ attribute[1] }}</p>
                      {% endfor %}
                    {% endif %}
                    <p class="product-quantity">Cantidad: {{ item.quantity }}</p>
                  </div>

                  <div class="product-price">
                    {{ item.line_price | money }}
                  </div>
                </div>
              {% endfor %}
            </div>

            <div class="summary-totals">
              <div class="summary-item">
                <span class="summary-item-label">Subtotal</span>
                <span class="summary-item-value">{{ checkout.subtotal_price | money }}</span>
              </div>

              {% if checkout.shipping_price > 0 %}
                <div class="summary-item">
                  <span class="summary-item-label">Envío</span>
                  <span class="summary-item-value">{{ checkout.shipping_price | money }}</span>
                </div>
              {% endif %}

              {% if checkout.tax_price > 0 %}
                <div class="summary-item">
                  <span class="summary-item-label">Impuestos</span>
                  <span class="summary-item-value">{{ checkout.tax_price | money }}</span>
                </div>
              {% endif %}

              <div class="summary-item summary-total">
                <span class="summary-item-label">Total</span>
                <span class="summary-item-value">{{ checkout.total_price | money }}</span>
              </div>
            </div>

            <div class="checkout-security">
              <p class="form-success">
                🔒 Información segura y protegida
              </p>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="checkout-error">
        <h1 class="checkout-title">Sesión de Checkout No Encontrada</h1>
        <p class="checkout-subtitle">La sesión de checkout ha expirado o no es válida.</p>
        <a href="{{ routes.cart_url }}" class="checkout-button secondary"><span>Volver al Carrito</span></a>
      </div>
    {% endif %}
  </div>
</section>

{% comment %}
  Los estilos del checkout están definidos en assets/checkout.css
{% endcomment %}

{% javascript %}
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('checkout-form');
  const submitBtn = document.getElementById('submit-checkout');

  if (form && submitBtn) {
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    form.addEventListener('submit', function() {
      // Agregar clase de loading
      form.classList.add('checkout-loading');
      submitBtn.disabled = true;

      // Cambiar texto del botón
      if (btnText) btnText.style.display = 'none';
      if (btnLoading) btnLoading.style.display = 'inline';
    });
  }
});
{% endjavascript %}

{% schema %}
{
  "name": "Checkout",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Título",
      "default": "Finalizar Compra"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtítulo",
      "default": "Completa tu información para procesar tu pedido"
    }
  ]
}
{% endschema %}
